{% extends '../messagesBase.html' %}
{% block entity %}
{% load static %}

<h2>Export to csv</h2>
<div id="export_notoria_form">
    <form method="post">
        {% csrf_token %}
        <div class="col-sm-5 col-xs-5">
            <div class="form-group m-3">
                <label for="file_name">File name</label>
                <input class="form-control" id="file_name" type="text" name="file_name" value="{{ file_name }}">
            </div>

            <div class="form-group m-3">
                <label>Data type</label>
                <select class="form-control" id="id_chosen_data" name="chosen_data" onchange="tableChange()">
                    <option value="-da">Detailed assets</option>
                    <option value="-ca">Assets categories</option>
                    <option value="-fa">Full assets</option>
                    <option value="-de">Detailed equity and liabilities</option>
                    <option value="-ce">Equity and liabilities categories</option>
                    <option value="-fe">Full equity and liabilities</option>
                    <option value="-f">Financial ratios</option>
                    <option value="-d">DuPont Indicators</option>
                    <option value="-s">Stock quotes</option>
                    <option value="-mv">Market values</option>
                </select>
            </div>
            <div class="form-group m-3">
                <label>Companies</label>
                <input type="button" class="btn-success btn-sm" id="select-all" value="Select All">
                <input type="button" class="btn-secondary btn-sm" id="clear-all" value="Clear All">
                {{form.chosen_companies}}
            </div>
            <fieldset class="border m-3 p-2">
                <legend class="form-legend">Frequency</legend>
                <div id="id_chosen_interval_balance">{{form.chosen_interval_balance}}</div>
                <div id="id_chosen_interval_ratios">{{form.chosen_interval_ratios}}</div>
                <div id="id_chosen_interval_stooq">{{form.chosen_interval_stooq}}</div>
                <div id="id_chosen_interval_gpw">{{form.chosen_interval_gpw}}</div>
            </fieldset>
            {{form.date_ranges_count}}
            <fieldset class="border m-3 p-2">
                <legend class="form-legend">Periods <i id="add-another" data-toggle="tooltip"
                                                       title="Add more periods"
                                                       class="fas fa-plus">
                </i></legend>
                <div class="form-row">
                    <div class="">
                        <label>From:</label>
                        <div style="width: 12em; margin-right: 4em;">
                            {{form.start_date_0}}
                        </div>
                    </div>
                    <div class="">
                        <label>To:</label>
                        <div style="width: 12em;">
                            {{form.end_date_0}}
                        </div>
                    </div>
                </div>
            </fieldset>
            <div class="form-group float-md-right submit-button">
                <input type="submit" class="btn-dark" value="Export">
            </div>
        </div>
    </form>
</div>
{{form.errors}}
<script>
    let form_count = Number($("[name=date_ranges_count]").val());

    let stooq_interval_elem = $('#id_chosen_interval_stooq');
    let gpw_interval_elem = $('#id_chosen_interval_gpw');
    let ratios_interval_elem = $('#id_chosen_interval_ratios');
    let balance_interval_elem = $('#id_chosen_interval_balance');
    var $select2companies
    const intervals = {
        '-f': ratios_interval_elem,
        '-d': ratios_interval_elem,
        '-s': stooq_interval_elem,
        '-mv': gpw_interval_elem
    }
    let balance_sheet_intervals = ['-da', '-ca', '-fa', '-de', '-ce', '-fe']
    balance_sheet_intervals.forEach(v => {
        intervals[v] = balance_interval_elem
    })

    let dates = $(".form-row");

    $("#add-another").click(function () {
        form_count++;

        let element = dates.clone();
        element.children().first().find('input').attr('name', 'start_date_' + form_count);
        element.children().first().find('input').attr('id', 'id_start_date_' + form_count);

        element.children().last().find('input').attr('name', 'end_date_' + form_count);
        element.children().last().find('input').attr('id', 'id_end_date_' + form_count);

        element.insertAfter($('div.form-row:last'));

        $("[name=date_ranges_count]").val(form_count);
    });

    function tableChange() {
        const selected_value = $('#id_chosen_data').children("option:selected").val();
        $.each(intervals, function (k, v) {
            v.hide();
        })
        intervals[selected_value].show();
    }

    $(document).ready(function () {
        var selectedValues = [];
        $('#id_chosen_interval_ratios').hide();
        $('#id_chosen_interval_stooq').hide();
        $('#id_chosen_interval_gpw').hide();
        $select2companies = $('.companies-multi-select2').select2({
            ajax: {
                url: 'company-autocomplete/',
                data: function (params) {
                    var query = {
                        q: params.term,
                        type: 'public',
                        page: params.page || 1
                    }
                    return query;
                },
                processResults: function (data) {
                    selectedValues = [];
                    var select2 = $('.companies-multi-select2');
                    select2.empty();
                    $.each(data.results, function (i, item) {
                        select2.append($('<option>', {
                            value: item.id,
                            text: item.text
                        }));
                        selectedValues.push(item.id);
                    });
                    return {
                        'results': data.results
                    };
                }
            },
            closeOnSelect: false,
        });

        $("#select-all").click(function () {
            var select2 = $('.companies-multi-select2');
           // if ($("#select-all").is(':checked')) {
                select2.val(selectedValues).trigger('change');
                $("#id_chosen_companies > option").prop("selected", "selected");
                $(".select2-hidden-accessible").trigger("change");
            //} else {
               // select2.empty();
               // select2.val("").trigger('change');
               // $("#id_chosen_companies > option").prop("selected", "");
               // $(".select2-hidden-accessible").trigger("change");
           // }
        });
        $("#clear-all").click(function () {
            var select2 = $('.companies-multi-select2');
           // if ($("#select-all").is(':checked')) {
               // select2.val(selectedValues).trigger('change');
               // $("#id_chosen_companies > option").prop("selected", "selected");
               // $(".select2-hidden-accessible").trigger("change");
            //} else {
                select2.empty();
                select2.val("").trigger('change');
                $("#id_chosen_companies > option").prop("selected", "");
                $(".select2-hidden-accessible").trigger("change");
           // }
        });
    })
    window.onload = function () {
    };
    $('[data-toggle="tooltip"]').tooltip()
</script>
{% endblock %}